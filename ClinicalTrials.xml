<?xml version="1.0" encoding="UTF-8" ?> 
<Module>
  <ModulePrefs title="Clinical Trials" description="Clinical Trials"> 
    <Require feature="opensocial-0.9"/>
    <Require feature="views"/>
    <Require feature="osapi"/>
    <Require feature="dynamic-height"/>
    <Require feature="jsonld"/>
    <Require feature="orng"/>
  </ModulePrefs>

  <Content type="html" view="default, home, profile">
    <![CDATA[
      <!DOCTYPE html>
      <link rel="stylesheet" type="text/css" href="css/csl_gadget.css">
      <script type="text/javascript" src="http://ajax.googleapis.com/ajax/libs/jquery/1.11.0/jquery.min.js"></script>
      <script type="text/javascript" src="http://ajax.googleapis.com/ajax/libs/jqueryui/1.11.1/jquery-ui.min.js"></script>
      <script type="text/javascript" src="http://s3.amazonaws.com/clinical-trials-gadget/xml/js/environment.js" ></script>
      <script type="text/javascript" src="js/os.js" ></script>
      <script type="text/javascript">

        function getImgByStat(status){
          switch(status.toLowerCase()){
            case 'recruiting':
            case 'enrolling by invitation':
              return '/images/check_icon.png';
            case 'active, not recruiting':
            case 'not yet recruiting':
              return '/images/yellow_triangle_icon.png';
            case 'completed':
            case 'suspended':
            case 'terminated':
            case 'withdrawn':
              return '/images/X_icon.png';
            default:
              return null;
          }          
        }

        function getOrderNumByStat(status){
          switch(status.toLowerCase()){
            case 'recruiting':
              return 1;
            case 'enrolling by invitation':
              return 2;
            case 'active, not recruiting':
              return 3;
            case 'not yet recruiting':
              return 4;
            case 'completed':
              return 5;
            case 'suspended':
              return 6;
            case 'terminated':
              return 7;
            case 'withdrawn':
              return 8;
            default:
              return 9;
          }        
        }

        function getAPIUrl(callback){
          var fullname, baseUrl = "http://scctsi-ctds-production.herokuapp.com/1/clinical_trials/";
          osapi.jsonld.getOwner().execute(function(result){
            fullname = result.jsonld['foaf:firstName'] + ' ' + result.jsonld['foaf:lastName'];

            // for testing only
            if(fullname === "chi kwan") fullname = "Linda Sher";
            if(callback)
              callback(fullname.length ? baseUrl + "?pi_full_name=" + fullname : null);
          }); 
        }

        function getAPIData(callback){
          getAPIUrl(function(url){
            if(url !== null){
              $.getJSON(url, function(result){
                if(callback){
                  callback(result);
                }
              });  
            }
          });
        }

        function getAppData(callback){
          osapi.appdata.get({'userId':'@owner',
            'groupId':'@self',
            'appId':'@app',
            'fields':'ct_data'
          }).execute(function(result){
            if(callback)
              callback(result);
          });
        }

        function loadTrialOrder(callback){
          getAPIData(function(apiData){
            getAppData(function(appData){
              if(!apiData.error && !appData.error){
                var viewer = os.osapi.getViewerFromResult(appData);
                var trials = [];

                if(apiData.count){
                  sortTrials(apiData.response);
                  if($.isEmptyObject(viewer)){
                    for(var i=0; i<apiData.response.length; i++){
                      var trial = {};
                      trial.i = apiData.response[i].id + '';
                      trial.f = 0;
                      trial.v = 1;
                      trials.push(trial);
                    }
                  } else {
                    var trialObj = JSON.parse(viewer.ct_data);
                    var newTrials = findNewTrial(trialObj, apiData.response)
                    if(newTrials.length){
                      trials = trialObj.slice();
                      for(var i=0; i<newTrials.length; i++){
                        var trial = {};
                        trial.i = newTrials[i] + '';
                        trial.f = 0;
                        trial.v = 1;
                        trials.push(trial);
                      }
                    }
                  }

                  if(trials.length){
                    osapi.appdata.update({'userId':'@owner',
                      'groupId':'@self',
                      'appId':'@app',
                      'data':{'ct_data':JSON.stringify(trials)}
                    }).execute(function(response){
                      if(callback){
                        callback(trials, apiData);
                      }
                    });  
                  } else {
                    if(callback){
                      callback(JSON.parse(viewer.ct_data), apiData);
                    }
                  }
                }
              }
            });
          });
        }

        function sortTrials(trials){
          if(trials.length > 1){
            trials.sort(function(a,b){
              if(a.recruitingStatus === b.recruitingStatus)
                return new Date(b.studyCompletionDate) - new Date(a.studyCompletionDate);
              return getOrderNumByStat(a.recruitingStatus) - getOrderNumByStat(b.recruitingStatus);
            });
          }
        }

        function findNewTrial(dbArr, apiArr){
          var hash = {}, diffArr = [];
          for(var i=0; i<dbArr.length; i++){
            hash[dbArr[i].i] = true;
          }

          for(var i=0; i<apiArr.length; i++){
            if(hash[apiArr[i].id] !== true){
              diffArr.push(apiArr[i].id);
            }
          }
          return diffArr;
        }

        function findTrial(id, jsonObj){
          for(var i in jsonObj.response){
            if(jsonObj.response[i].id == id){
              return jsonObj.response[i];
            }
          }
          return null;
        }

        function displayData(orderList, jsonObj, showVisible, callback){
          var displayCount = 3;
          for(var i=0; i<orderList.length; i++){
            var t = findTrial(orderList[i].i,jsonObj);
            if(t !== null && (showVisible || orderList[i].v === 1)){
              renderTrial(t.id, t.officialTitle, t.recruitingStatus, t.diseaseArea, t.siteStatus, t.url, orderList[i].v, orderList[i].f);
            }
          }
          
          if(gadgets.views.getCurrentView().name_ === "profile"){
            if(orderList.length > 2){
              $("<div id='showhide' class='collapse'><span>Show more</span></div>").appendTo(".clinicalTrialGadget");
              $("<img>",{src:"http://profilesstage.sc-ctsi.org/Framework/Images/expandRound.gif"}).appendTo("#showhide");
              $("#trial-list-full li:gt(1)").hide();
            }
          }

          gadgets.window.adjustHeight($(".clinicalTrialGadget").height() + 80);
        }

        function renderTrial(pid, title, recStat, disease, siteStat, url, isVisible, isFeature){
          var textToInsert = '<li id=' + pid + ' class="trial' + (isVisible === 0 ? " trial-hidden" : "") + (isFeature === 1 ? " trial-feature" : "") + '">';
            textToInsert += '<img class="icon-eye" src="' + ENV_LOCAL_URL + '/images/eye_icon.png">';
            textToInsert += '<img class="icon-star" src="' + ENV_LOCAL_URL + '/images/' + (isFeature === 1 ? "star_filled" : "star_empty") + '.png">';
            textToInsert += '<div class="title"><a href="' + url + '" target="_blank">' + title + '</a></div>';
            textToInsert += '<div class="detail"><img class="statImg" src="' + ENV_LOCAL_URL + getImgByStat(recStat) + '">';
            textToInsert += '<span class="status">' + recStat + '</span>';
            textToInsert += '<span class="disease"> | DISEASE AREA: ' + disease + '</span>';
            textToInsert += '<span class="site"> | ' + siteStat + '</span></div>';
            
            if(isFeature === 1){
              $("#trial-list-feat").append(textToInsert);
            } else {
              $("#trial-list").append(textToInsert);
            }
        }

        function adjustHeight(){
          gadgets.window.adjustHeight($(".clinicalTrialGadget").height() + 80);
        }

      </script>
    ]]>
  </Content>

  <Content type="html" view="profile" preferred_width="700">
    <![CDATA[     
      <script type="text/javascript">

        function init(){
          loadTrialOrder(function(result, result2){
            displayData(result, result2, false);
          });
        }

        gadgets.util.registerOnLoadHandler(function(){
          $(document).ready(function() {
            init();

            $(".view-profile").on("click", "#showhide", function(){
              if($(this).hasClass("collapse")){
                $("#trial-list-full li").show();
                $(this).removeClass("collapse");
                $("#showhide span").text("Show less");
                $("#showhide img").attr("src","http://profilesstage.sc-ctsi.org/Framework/Images/collapseRound.gif");
                adjustHeight();
              } else {
                $("#trial-list-full li:gt(1)").hide();
                $(this).addClass("collapse");
                $("#showhide span").text("Show more");
                $("#showhide img").attr("src","http://profilesstage.sc-ctsi.org/Framework/Images/expandRound.gif");
                adjustHeight();
              }
              
            });
          });
        });
      
      </script>

      <div id='debug'></div>
      <div class="view-profile">
        <div class="clinicalTrialGadget">
          <div>
            <span class="HeaderImage"><img src="images/microscope_iconRY.png"></span>
            <span class="HeaderTitle">Active Clinical Trials</span>
          </div>
          <div id="trial-list-full">
            <ul id="trial-list-feat">
            </ul>
            <ul id="trial-list">
            </ul>
          </div>
        </div> 
      </div>
    ]]>
  </Content>  

  <Content type="html" view="home" preferred_width="700">
    <![CDATA[
     
      <script type="text/javascript">

        var gadgetPath = "https://s3.amazonaws.com/clinical-trials-gadget/xml/";
        var elemList = "sortable",
          elemTrial = "li.trial",
          classTrial = "trial",
          classTrialHidden = "trial-hidden",
          classIconEye = "icon-eye",
          classIconStar = "icon-star",
          urlPath = "https://s3.amazonaws.com/clinical-trials-gadget/xml/";

        gadgets.util.registerOnLoadHandler(function(){

          $(document).ready(function(){

            $("#trial-list-feat").sortable({
              axis: "y",
              scroll: true,

              start: function(event, ui){
                ui.placeholder.height(ui.item.height());
              },

              update: function(event, ui){
                saveTrialStatus();
              }              
            });
            
            $("#trial-list").sortable({
              axis: "y",
              scroll: true,

              start: function( event, ui ) {
                ui.placeholder.height(ui.item.height());
              },

              update: function(event, ui) {
                saveTrialStatus();
              },

              items: "li:not(." + classTrialHidden + ")",
              cancel: "." + classTrialHidden
            });

            $(".view-home").on("click", ".icon-eye", function( event ){
              event.preventDefault();
              var $trial = findTrialElement($(this));
              if ( $trial !== null ) {
                processTrialEyeClick($trial);
                saveTrialStatus();
              }
            });

            $(".view-home").on("click", ".icon-star", function( event ){
              event.preventDefault();
              var $trial = findTrialElement( $(this) );
              if ( $trial !== null ) {
                processTrialStarClick( $trial );
                saveTrialStatus();
              }
            });

            $("#clear").on("click", function(event){
              osapi.appdata.delete({
                'userId':'@owner',
                'groupId':'@self',
                'appId':'@app',
                'fields':'ct_data'
              }).execute(function(){
                alert('clear');
              });
            })

            $("#show").on("click", function(event){
              osapi.appdata.get({
                'userId':'@owner',
                'groupId':'@self',
                'appId':'@app',
                'fields':'ct_data'
              }).execute(function(result){
                var viewer = os.osapi.getViewerFromResult(result);
                alert(viewer.ct_data);
              });
            })

            loadTrialOrder(function(result,result2){
              displayData(result,result2,true);
            });
          });  
        });

        function saveTrialStatus(){
          var featItem = $("ul#trial-list-feat li.trial");
          var listItem = $("ul#trial-list li.trial");
          var trials = [];

          featItem.each(function() {
            trial = {};
            trial.i = $(this).attr("id");
            trial.f = 1
            trial.v = 1
            trials.push(trial);
          });

          listItem.each(function() {
            trial = {};
            trial.i = $(this).attr("id");
            trial.f = 0
            trial.v = $(this).attr("class").indexOf("trial-hidden") > 0 ? 0 : 1;
            trials.push(trial);
          });

          if(listItem.length > 0){
            osapi.appdata.update({
              'userId':'@owner',
              'groupId':'@self',
              'appId':'@app',
              'data':{'ct_data':JSON.stringify(trials)}
            }).execute(function(response){
            });
          }
        }

        function findTrialElement($elem){
          return $elem.parents("li.trial");
        }

        function processTrialEyeClick($trial){
          var $trialLastVisible = findLastVisibleTrial();
          toggleTrialVisibility($trial);
          moveTrialToEndOfVisibleList($trial, $trialLastVisible);
        }

        function findLastVisibleTrial() {
          var $trialList = $("#trial-list").children();
          var $trialLastVisible = null; // $( "#"+elemList+" li:last" );
          $trialList.each( function( index ) {
            if ( !( $( this ).hasClass( classTrialHidden ) ) ) {
              $trialLastVisible = $( this );
            } else {
            // exits the loop
              return false;
            }   
          });
          return $trialLastVisible;
        }

        function toggleTrialVisibility($trial){
          if($trial.hasClass("trial-hidden")){
            $trial.removeClass("trial-hidden");
          } else {
            $trial.addClass("trial-hidden");
            if ( $trial.hasClass("trial-feature")){
              $trial.find(".icon-star").attr("src",urlPath + "images/star_empty.png");
              $trial.removeClass("trial-feature");
            } 
          }
        }

        function moveTrialToEndOfVisibleList($trial, $trialLastVisible) {
          
          var $clone = $trial.clone(true, true);
          if ( $trial.is( $trialLastVisible ) ) {
            $clone.appendTo( $( "#trial-list" ) );
          } else if ( $trialLastVisible === null ) {
            $clone.insertBefore( $( "#trial-list" ).children()[0] );
          } else {
            $clone.insertAfter( $trialLastVisible );
          }
          $trial.remove();
        }

        function processTrialStarClick($trial){
          var $trialLastFeature = findLastFeatureTrial();
          moveTrialToEndOfFeatureList($trial, $trialLastFeature);
          toggleTrialFeature($trial);
        }

        function toggleTrialFeature($trial) {  
          if ( $trial.hasClass( "trial-feature" ) ) {
            $trial.find("." + classIconStar).attr("src",urlPath + "images/star_empty.png");
            $trial.removeClass( "trial-feature" );
          } else {
            $trial.find("." + classIconStar).attr("src",urlPath + "images/star_filled.png");
            $trial.addClass( "trial-feature" );
          }
        }

        function moveTrialToEndOfFeatureList($trial, $trialLastVisible){
          if( !($trial.hasClass("trial-feature"))){
            $("#trial-list-feat").prepend($trial);
          }
          else {
            $("#trial-list").prepend($trial);
          }
        }

        function findLastFeatureTrial(){
          var $trialLastFeature = null;
          if($("#trial-list-feature").children(".trial-feature:last").length > 0)
            $trialLastFeature = $("#trial-list").children(".trial-feature:last");
          return $trialLastFeature;
        }

      </script>
      
      <div id="debug"></div>
      <div class="view-home">
        <div class="clinicalTrialGadget">
          <div>
            <span class="HeaderImage"><img src="images/microscope_iconRY.png"></span>
            <span class="HeaderTitle">Active Clinical Trials</span>
          </div>
          <ul id="trial-list-feat">
          </ul>
          <ul id="trial-list">
          </ul>
          <div id="debug2">
            <button id="show" type="button">show userdata</button>
            <button id="clear" type="button">clear userdata</button>
          </div>
        </div>
      </div>
    ]]>
  </Content>
</Module>
