<?xml version="1.0" encoding="UTF-8" ?> 
<Module>
  <ModulePrefs title="Demo2" description="Demo2"> 
    <Require feature="opensocial-0.9"/>
    <Require feature="views"/>
    <Require feature="osapi"/>
    <Require feature="dynamic-height"/>
    <Require feature="jsonld"/>
    <Require feature="orng"/>
  </ModulePrefs>

  <Content type="html" view="default, home, profile">
    <![CDATA[
      <!DOCTYPE html>
      <link rel="stylesheet" type="text/css" href="mystyle.css">
      <script type="text/javascript" src="http://ajax.googleapis.com/ajax/libs/jquery/2.1.0/jquery.min.js"></script>
      <script type="text/javascript" src="http://ajax.googleapis.com/ajax/libs/jqueryui/1.11.1/jquery-ui.min.js"></script>
      <script type="text/javascript" src="js/os.js" ></script>
      <script type="text/javascript">

        function getAPIUrl(callback){
          var baseUrl = "http://scctsi-ctds-production.herokuapp.com/1/clinical_trials/";

          osapi.jsonld.getOwner().execute(function(result){
            var fullname = result.jsonld['prns:fullName'];
            
            if(fullname === "chikwan")
              fullname = "Agustin Garcia";
            
            $(".debug").text(result.jsonld.fullName);
            if(callback)
              callback((result.jsonld.fullName === '') ? null : baseUrl + "?pi_full_name=" + fullname);
          }); 
        }

        function getImageByStatus(status){
          switch(status){
            case 'Recruiting':
            case 'Enrolling by invitation':
              return 'images/check_icon.png';
            case 'Active, not recruiting':
            case 'Not yet recruiting':
              return 'images/yellow_triangle_icon.png';
            case 'Completed':
            case 'Suspended':
            case 'Terminated':
            case 'Withdrawn':
              return 'images/X_icon.png';
            default:
              return null;
          }
        }

        function getOrderNumByStatus(status){
          switch(status){
            case 'Recruiting':
              return 1;
            case 'Enrolling by invitation':
              return 2;
            case 'Active, not recruiting':
              return 3;
            case 'Not yet recruiting':
              return 4;
            case 'Completed':
              return 5;
            case 'Suspended':
              return 6;
            case 'Terminated':
              return 7;
            case 'Withdrawn':
              return 8;
            default:
              return 9;
          }        
        }

        function sortTrials(data){
          var trials = data.response;
          trials.sort(function(a,b){
            if(a.recruitingStatus === b.recruitingStatus)
              return new Date(b.studyCompletionDate) - new Date(a.studyCompletionDate);
            return getOrderNumByStatus(a.recruitingStatus) - getOrderNumByStatus(b.recruitingStatus);
          });
        }

        function getTrialOrder(callback){
          osapi.appdata.get({
            'userid':'@owner',
            'groupId':'@self',
            'appId':'@app',
            'fields':'order'
          }).execute(function(result){
            var owner = os.osapi.getOwnerFromResult(result);
            var order = owner.order;
            if(order.length > 0 && callback){
              callback($.parseJSON(order));
            }
          });
        }

        function getTrialData(callback){
          getAPIUrl(function(path){
            if(path !== null){
              $.getJSON(path, function(json){
                if(callback)
                  callback(json);
              });
            }
          });
        }

        function displayData(orderList, jsonObj){
          for(var i=0; i<orderList.length; i++){
            var t = findTrial(orderList[i].i,jsonObj);
            if(t !== null){
              renderTrial(t.id, t.officialTitle, t.recruitingStatus, t.diseaseArea, t.siteStatus, t.url, orderList[i].v, orderList[i].f);
            }
          }
          gadgets.window.adjustHeight(3000);
        }

        function renderTrial(id,title,recStat,disease,siteStat,url,visible,feature){
          var menu = $('#sortable');
          var li, div;
          li = $('<li/>').addClass('menu-item').appendTo(menu);
          //$('<div/>').addClass("test").text(result.response[i].studyCompletionDate).appendTo(li);
          $("<a/>").addClass("title").attr({href:parseURLFromATag(url), target:"_blank"}).text(title).appendTo(li);
            
          div = $('<div/>').addClass("detail").appendTo(li);
            
          if(recStat.length > 0)
            $('<img/>').addClass("statImg").attr('src','http://s3.amazonaws.com/clinical-trials-gadget/xml/' + getImageByStatus(recStat)).appendTo(div);
            
          $('<span/>').addClass("status").text(recStat).appendTo(div);
          div.append(" | DISEASE AREA: ");
          $('<span/>').addClass("disease").text("").text(disease).appendTo(div);
          div.append(" | ");
          $('<span/>').addClass("site").text(siteStat).appendTo(div);
        }

        function findTrial(id, jsonObj){
          for(var i in jsonObj.response){
            if(jsonObj.response[i].id == id){
              console.log('found');
              return jsonObj.response[i];
            }
          }
          return null;
        }

        function loadTrialOrder(){
          getAPIUrl(function(path){
            if(path !== null){
              $.getJSON(path, function(result){
                if(!result.error){
                  var trials = [];
                  for(var i=0; i<result.response.length; i++){
                    var trial = {};
                    trial.i = "" + result.response[i].id;
                    trial.f = 1;
                    trial.v = 1;
                    trials.push(trial);
                  }
                  
                  osapi.appdata.update({
                    'userId':'@owner',
                    'groupId':'@self',
                    'appId':'@app',
                    'data':{'order':JSON.stringify(trials)}
                  }).execute(function(response){
                  });
                }
              });
            }
          });
        }

        function makeRequest(callback){
          getAPIUrl(function(path){
            if(path != null){
              $.getJSON(path, function(result){
                if(callback){
                  callback(null, result);
                }
              });
            }
          });  
        }

        function parseURLFromATag(text){
          var urlStart = text.lastIndexOf('href=') + 5;
          var urlEnd = text.indexOf('>');
          return text.slice(urlStart, urlEnd).replace(/'/g,'').replace(/"/g,'');
        }

      </script>
    ]]>
  </Content>

  <Content type="html" view="profile" preferred_width="700">
    <![CDATA[     
      <script type="text/javascript">

        var gadgetPath = "https://s3.amazonaws.com/clinical-trials-gadget/xml/";

        function init(){
          $("#debug").html("update 1");
          makeRequest(renderClinicalTrial);
        }

        function renderClinicalTrial(errno, result){

          sortTrials(result);
          var menu = $('#sortable');
          var li, div;

          for(var i=0;i<result.response.length;i++){
            li = $('<li/>').addClass('menu-item').appendTo(menu);
            $('<div/>').addClass("test").text(result.response[i].studyCompletionDate).appendTo(li);
            $("<a/>").addClass("title").attr({href:parseURLFromATag(result.response[i].url), target:"_blank"}).text(result.response[i].officialTitle).appendTo(li);
            
            div = $('<div/>').addClass("detail").appendTo(li);
            
            if(result.response[i].recruitingStatus.length > 0)
              $('<img/>').addClass("statImg").attr('src','http://s3.amazonaws.com/clinical-trials-gadget/xml/' + getImageByStatus(result.response[i].recruitingStatus)).appendTo(div);
            
            $('<span/>').addClass("status").text(result.response[i].recruitingStatus).appendTo(div);
            div.append(" | DISEASE AREA: ");
            $('<span/>').addClass("disease").text("").text(result.response[i].diseaseArea).appendTo(div);
            div.append(" | ");
            $('<span/>').addClass("site").text(result.response[i].siteStatus).appendTo(div);
            
          }
          gadgets.window.adjustHeight(3000);
        }

        gadgets.util.registerOnLoadHandler(init);
      
      </script>

      <div id='debug'></div>
      <div class="gadgetContainer">
        <div>
          <span class="HeaderImage"><img src="images/microscope_iconR.png"></span>
          <span class="HeaderTitle">Active Clinical Trials</span>
        </div>
        <ul id="sortable">
        </ul> 
      </div>
    ]]>
  </Content>  

  <Content type="html" view="home" preferred_width="700">
    <![CDATA[
     
      <script type="text/javascript">

        var gadgetPath = "https://s3.amazonaws.com/clinical-trials-gadget/xml/";
        var elemList = "sortable",
          elemTrial = "li.trial",
          classTrial = "trial",
          classTrialHidden = "trial-hidden",
          classIconEye = "icon-eye",
          classIconStar = "icon-star",
          urlPath = "https://s3.amazonaws.com/clinical-trials-gadget/xml/";

        function init(){
          $("#debug").html("update 3");
          //loadTrialOrder();
          //makeRequest(renderClinicalTrial);
          //loadTrialOrder();
          //loadTrials();
          getTrialOrder(function(orderObj){
            getTrialData(function(dataObj){
              displayData(orderObj, dataObj);
            });
          });
        }

        function renderClinicalTrial(errno, result){

          var menu = $('#sortable');
          var li, div;

          for(var i=0;i<result.response.length;i++){
            li = $('<li/>').addClass('menu-item').appendTo(menu);

            $('<div/>').addClass("title").text(result.response[i].officialTitle).appendTo(li);
            div = $('<div/>').addClass("detail").appendTo(li);

            if(result.response[i].recruitingStatus.length > 0)
              $('<img/>').addClass("statImg").attr('src','http://s3.amazonaws.com/clinical-trials-gadget/xml/' + getImageByStatus(result.response[i].recruitingStatus)).appendTo(div);

            $('<span/>').addClass("status").text(result.response[i].recruitingStatus).appendTo(div);
            div.append(" | DISEASE AREA: ");
            $('<span/>').addClass("disease").text("").text(result.response[i].diseaseArea).appendTo(div);
            div.append(" | ");
            $('<span/>').addClass("site").text(result.response[i].siteStatus).appendTo(div);
          }
          $('.title').before('<img class="eye" src =' + gadgetPath + 'images/eye_icon.png><img class="star" src =' + gadgetPath + 'images/star_filled.png>'); 
          gadgets.window.adjustHeight(3000);
        }

        gadgets.util.registerOnLoadHandler(function(){
          $(document).ready(function() {

            $("#sortable").sortable({
              start: function( event, ui ) {
                ui.placeholder.height(ui.item.height());
              },

              items: "li:not(." + classTrialHidden + ")",
              cancel: "." + classTrialHidden
            });

            $( "."+classIconEye ).click( function( event ){
              event.preventDefault();
              var $trial = findTrialElement( $(this) );
              if ( $trial !== null ) {
                processTrialEyeClick( $trial );
              }
            });

            $( "."+classIconStar ).click( function( event ){
              event.preventDefault();
              var $trial = findTrialElement( $(this) );
              if ( $trial !== null ) {
               processTrialStarClick( $trial );
              }
            });

            init();
          });  
        });
        
      </script>
      
      <div id='debug'></div>
      <div id='jsonCnt'></div>

      <div class="gadgetContainer">
        <div>
          <span class="HeaderImage"><img src="images/microscope_iconR.png"></span>
          <span class="HeaderTitle">Active Clinical Trials</span>
        </div>
        <ul id="sortable">
        </ul> 
      </div>
    ]]>
  </Content>
</Module>
